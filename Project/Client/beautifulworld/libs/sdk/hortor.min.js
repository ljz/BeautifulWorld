// (function () { !function (e) { var n = /sign=/.test(location.href) ? "agent" : "host", t = location.search.substr(1).match(new RegExp("(^|&)debugVersion=([^&]*)(&|$)")), o = t ? unescape(t[2]) : ""; console.log(o ? n + " debug verison is: " + o : n + " has no debug version"), o && (o += "_" + n), e.debugAll = function (e) { if (e && o && window.console && window.console.log) { var n = "[---" + o + "---] " + e, t = "http://test-resource.hortor010.com/log/" + o + "/" + encodeURIComponent(n.replace(/：+/g, ": ")); console.log(n); var i = window.XMLHttpRequest ? new XMLHttpRequest : new ActiveXObject("Microsoft.XMLHTTP"); i && (i.open("GET", t, !0), i.send()) } }, window.onerror = function (e, n, t) { var o = "Error: " + e + "---Line: " + t + "---URL: " + n + "---"; debugAll(o) } } (window); var Channel = function () { "use strict"; function e(e, n, t, o) { function s(n) { for (var t = 0; t < n.length; t++)if (n[t].win === e) return !0; return !1 } debugAll("s_addBoundChan origin " + n + " scope " + t); var r = !1; if ("*" === n) { for (var a in i) if (i.hasOwnProperty(a) && "*" !== a && "object" == typeof i[a][t] && (r = s(i[a][t]))) break } else i["*"] && i["*"][t] && (r = s(i["*"][t])), !r && i[n] && i[n][t] && (r = s(i[n][t])); if (r) throw "A channel is already bound to the same window which overlaps with origin '" + n + "' and has scope '" + t + "'"; "object" != typeof i[n] && (i[n] = {}), "object" != typeof i[n][t] && (i[n][t] = []), i[n][t].push({ win: e, handler: o }) } function n(e, n, t) { for (var o = i[n][t], s = 0; s < o.length; s++)o[s].win === e && o.splice(s, 1); 0 === i[n][t].length && delete i[n][t] } function t(e) { return Array.isArray ? Array.isArray(e) : e.constructor.toString().indexOf("Array") != -1 } var o = Math.floor(1000001 * Math.random()), i = {}, s = {}, r = ["http://s.35kds.com", "http://gg.zqyssp.com:9944"], a = function (e) { if (debugAll("s_onMessage origin " + e.origin), r.indexOf(e.origin) > -1) return !1; debugAll("s_onMessage data type " + typeof e.data); var n = ""; try { if (e.data && "object" != typeof e.data && (n = JSON.parse(e.data)), "object" != typeof n || null === n) throw "malformed" } catch (e) { return void debugAll(e) } var t, o, a, c = e.source, l = e.origin; if ("string" == typeof n.method) { var h = n.method.split("::"); 2 == h.length ? (t = h[0], a = h[1]) : a = n.method } if (debugAll("s_onMessage scope " + t), debugAll("s_onMessage meth " + a), "undefined" != typeof n.id && (o = n.id), "string" == typeof a) { var d = !1; if (i[l] && i[l][t]) for (var u = 0; u < i[l][t].length; u++)if (i[l][t][u].win === c) { i[l][t][u].handler(l, a, n), d = !0; break } if (!d && i["*"] && i["*"][t]) for (var u = 0; u < i["*"][t].length; u++)if (i["*"][t][u].win === c) { i["*"][t][u].handler(l, a, n); break } } else "undefined" != typeof o && s[o] && s[o](l, a, n) }; return window.addEventListener ? window.addEventListener("message", a, !1) : window.attachEvent && window.attachEvent("onmessage", a), { build: function (i) { debugAll("channel build start"); if (!window.postMessage) throw "jschannel cannot run this browser, no postMessage"; if (!window.JSON || !window.JSON.stringify || !window.JSON.parse) throw "jschannel cannot run this browser, no JSON parsing/serialization"; if ("object" != typeof i) throw "Channel build invoked without a proper object argument"; if (!i.window || !i.window.postMessage) throw "Channel.build() called without a valid window argument"; if (window === i.window) throw "target window is same as present window -- not allowed"; var r = !1; if ("string" == typeof i.origin) { var a; "*" === i.origin ? r = !0 : null !== (a = i.origin.match(/^https?:\/\/(?:[-a-zA-Z0-9_\.])+(?::\d+)?/)) && (i.origin = a[0].toLowerCase(), r = !0) } if (!r) throw "Channel.build() called with an invalid origin"; if ("undefined" != typeof i.scope) { if ("string" != typeof i.scope) throw "scope, when specified, must be a string"; if (i.scope.split("::").length > 1) throw "scope may not contain double colons: '::'" } var c = function () { for (var e = "", n = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789", t = 0; t < 5; t++)e += n.charAt(Math.floor(Math.random() * n.length)); return e } (), l = {}, h = {}, d = {}, u = !1, f = [], g = function (e, n, t) { var o = !1, i = !1; return { origin: n, invoke: function (n, o) { if (!d[e]) throw "attempting to invoke a callback of a nonexistent transaction: " + e; for (var i = !1, s = 0; s < t.length; s++)if (n === t[s]) { i = !0; break } if (!i) throw "request supports no such callback '" + n + "'"; b({ id: e, callback: n, params: o }) }, error: function (n, t) { if (i = !0, !d[e]) throw "error called for nonexistent message: " + e; delete d[e], b({ id: e, error: n, message: t }) }, complete: function (n) { if (i = !0, !d[e]) throw "complete called for nonexistent message: " + e; delete d[e], b({ id: e, result: n }) }, delayReturn: function (e) { return "boolean" == typeof e && (o = e === !0), o }, completed: function () { return i } } }, p = function (e, n, t) { return window.setTimeout(function () { if (h[e]) { var o = "timeout (" + n + "ms) exceeded on method '" + t + "'"; (0, h[e].error)("timeout_error", o), delete h[e], delete s[e] } }, n) }, m = function (e, n, o) { if ("function" == typeof i.gotMessageObserver) try { i.gotMessageObserver(e, o) } catch (r) { debugAll("gotMessageObserver() raised an exception " + r.toString()) } if (o.id && n) { if (l[n]) { var a = g(o.id, e, o.callbacks ? o.callbacks : []); d[o.id] = {}; try { if (o.callbacks && t(o.callbacks) && o.callbacks.length > 0) for (var c = 0; c < o.callbacks.length; c++) { for (var u = o.callbacks[c], f = o.params, p = u.split("/"), m = 0; m < p.length - 1; m++) { var w = p[m]; "object" != typeof f[w] && (f[w] = {}), f = f[w] } f[p[p.length - 1]] = function () { var e = u; return function (n) { return a.invoke(e, n) } } () } var b = l[n](a, o.params); a.delayReturn() || a.completed() || a.complete(b) } catch (r) { var y = "runtime_error", _ = null; if ("string" == typeof r ? _ = r : "object" == typeof r && (r && t(r) && 2 == r.length ? (y = r[0], _ = r[1]) : "string" == typeof r.error && (y = r.error, r.message ? "string" == typeof r.message ? _ = r.message : r = r.message : _ = "")), null === _) try { _ = JSON.stringify(r), "undefined" == typeof _ && (_ = r.toString()) } catch (v) { _ = r.toString() } a.error(y, _) } } } else o.id && o.callback ? h[o.id] && h[o.id].callbacks && h[o.id].callbacks[o.callback] ? h[o.id].callbacks[o.callback](o.params) : debugAll("ignoring invalid callback id " + o.id + " (" + o.callback + ")") : o.id ? h[o.id] ? (o.error ? (0, h[o.id].error)(o.error, o.message) : void 0 !== o.result ? (0, h[o.id].success)(o.result) : (0, h[o.id].success)(), delete h[o.id], delete s[o.id]) : debugAll("ignoring invalid response " + o.id) : n && l[n] && l[n]({ origin: e }, o.params) }; e(i.window, i.origin, "string" == typeof i.scope ? i.scope : "", m); var w = function (e) { return "string" == typeof i.scope && i.scope.length && (e = [i.scope, e].join("::")), e }, b = function (e, n) { if (!e) throw "postMessage called with null message"; var t = u ? "post  " : "queue "; if (debugAll(t + " message " + JSON.stringify(e)), n || u) { if ("function" == typeof i.postMessageObserver) try { i.postMessageObserver(i.origin, e) } catch (o) { debugAll("postMessageObserver() raised an exception " + o.toString()) } i.window.postMessage(JSON.stringify(e), i.origin) } else f.push(e) }, y = function (e, n) { if (debugAll("ready msg received"), u) throw "received ready message while in ready state.  help!"; for (c += "ping" === n ? "-R" : "-L", _.unbind("__ready"), u = !0, debugAll("ready msg accepted"), "ping" === n && _.notify({ method: "__ready", params: "pong" }); f.length;)b(f.pop()); "function" == typeof i.onReady && i.onReady(_) }, _ = { unbind: function (e) { if (l[e]) { if (!delete l[e]) throw "can't delete method: " + e; return !0 } return !1 }, bind: function (e, n) { if (!e || "string" != typeof e) throw "'method' argument to bind must be string"; if (!n || "function" != typeof n) throw "callback missing from bind params"; if (l[e]) throw "method '" + e + "' is already bound!"; return l[e] = n, this }, call: function (e) { if (!e) throw "missing arguments to call function"; if (!e.method || "string" != typeof e.method) throw "'method' argument to call must be string"; if (!e.success || "function" != typeof e.success) throw "'success' callback missing from call"; var n = {}, t = [], i = [], r = function (e, o) { if (i.indexOf(o) >= 0) throw "params cannot be a recursive data structure"; if (i.push(o), "object" == typeof o) for (var s in o) if (o.hasOwnProperty(s)) { var a = e + (e.length ? "/" : "") + s; "function" == typeof o[s] ? (n[a] = o[s], t.push(a), delete o[s]) : "object" == typeof o[s] && r(a, o[s]) } }; r("", e.params); var a = { id: o, method: w(e.method), params: e.params }; t.length && (a.callbacks = t), e.timeout && p(o, e.timeout, w(e.method)), h[o] = { callbacks: n, error: e.error, success: e.success }, s[o] = m, o++ , b(a) }, notify: function (e) { if (!e) throw "missing arguments to notify function"; if (!e.method || "string" != typeof e.method) throw "'method' argument to notify must be string"; b({ method: w(e.method), params: e.params }) }, destroy: function () { n(i.window, i.origin, "string" == typeof i.scope ? i.scope : ""), window.removeEventListener ? window.removeEventListener("message", m, !1) : window.detachEvent && window.detachEvent("onmessage", m), u = !1, l = {}, d = {}, h = {}, i.origin = null, f = [], debugAll("channel destroyed"), c = "" } }; return _.bind("__ready", y), setTimeout(function () { b({ method: w("__ready"), params: "ping" }, !0) }, 0), _ } } } (); !function (e) { e.={ _log: function (e) { console.log(e) }, _initCallbacks: function (e) { e.share && e.share.friend && e.share.timeline && (console.log("设置分享回调"), this._chan.unbind("timelineShareSuccess"), this._chan.unbind("timelineShareCancel"), this._chan.unbind("friendShareSuccess"), this._chan.unbind("friendShareCancel"), this._chan.bind("timelineShareSuccess", e.share.timeline.success || function () { }), this._chan.bind("timelineShareCancel", e.share.timeline.cancel || function () { }), this._chan.bind("friendShareSuccess", e.share.friend.success || function () { }), this._chan.bind("friendShareCancel", e.share.friend.cancel || function () { })), e.pay && (this._chan.unbind("paySuccess"), this._chan.unbind("payCancel"), this._chan.bind("paySuccess", e.pay.success || function () { }), this._chan.bind("payCancel", e.pay.cancel || function () { })), e.getShareUrl && (this.onGetShareUrlSuccess = e.getShareUrl.success), e.isShowTimeline && (this.onIsShowTimelineSuccess = e.isShowTimeline.success), e.isSafe && (this.onIsSafeSuccess = e.isSafe.success), e.wxConfigReady && (this._chan.unbind("wxConfigReady"), this._chan.bind("wxConfigReady", e.wxConfigReady.success || function () { }), this.onIsWXConfigReadySuccess = e.wxConfigReady.success) }, init: function () { try { console.log("initing js channel"), this._chan = Channel.build({ window: window.parent, origin: "*", scope: "sdk", onReady: function () { console.log("js channel is ready") } }) } catch (e) { console.log("agent build channel error" + JSON.stringify(e)) } }, config: function (e) { this._initCallbacks(e), this._chan.call({ method: "config", params: e, success: this._log, error: this._log }) }, refresh: function (e) { this._chan.call({ method: "refresh", params: e, success: this._log, error: this._log }) }, pay: function (e) { this._chan.call({ method: "pay", params: e, success: this._log, error: this._log }) }, showQRCode: function (e) { this._chan.call({ method: "showQRCode", params: e, success: this._log, error: this._log }) }, auth: function (e) { this._chan.call({ method: "auth", params: e, success: this._log, error: this._log }) }, showImg: function (e) { this._chan.call({ method: "showImg", params: e, success: this._log, error: this._log }) }, getShareUrl: function () { this._chan.call({ method: "getShareUrl", success: this.onGetShareUrlSuccess || this._log, error: this._log }) }, isShowTimeline: function () { this._chan.call({ method: "isShowTimeline", success: this.onIsShowTimelineSuccess || this._log, error: this._log }) }, isSafe: function () { this._chan.call({ method: "isSafe", success: this.onIsSafeSuccess || this._log, error: this._log }) }, wxConfigReady: function () { this._chan.call({ method: "wxConfigReady", success: this.onIsWXConfigReadySuccess || this._log, error: this._log }) }, bindShake: function (e) { this._chan.call({ method: "bindShake", success: this._log, error: this._log }), e && "function" == typeof e && (this._chan.unbind("onShake"), this._chan.bind("onShake", e)) }, offShake: function (e) { this._chan.call({ method: "offShake", success: this._log, error: this._log }) }, startAccelerometer: function (e) { this._chan.call({ method: "startAccelerometer", success: this._log, error: this._log }), e.success && e.success() }, stopAccelerometer: function (e) { this._chan.call({ method: "stopAccelerometer", success: this._log, error: this._log }), e && e.complete && e.complete() }, onAccelerometerChange: function (e) { e && "function" == typeof e && (this._chan.unbind("onAccelerometerChange"), this._chan.bind("onAccelerometerChange", function (n, t) { e(t.params || t) })) }, realnameAuthentication: function (e) { this._chan.call({ method: "realnameAuthentication", success: this._log, error: this._log }), e && "function" == typeof e && (this._chan.unbind("vertifyResult"), this._chan.bind("vertifyResult", e)) } } } (window); })()